<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ© - Ù†Ø³Ø®Ø© Ù…Ø¹Ø¯Ù„Ø©</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --success: #16a34a;
      --warning: #ca8a04;
      --danger: #dc2626;
      --dark: #1e293b;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      min-height: 100vh;
      color: #1f2937;
    }

    header {
      background: linear-gradient(to right, #1e3a8a, #3b82f6);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    header h1 { font-size: 2rem; margin-bottom: 0.5rem; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }

    .stats {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1rem;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
    #dataTable { display:none; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
      justify-content: center;
    }

    input[type="text"], input[type="number"], select {
      padding: 0.8rem 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.0rem;
      width: 100%;
      max-width: 400px;
    }

    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-add { background:#16a34a; color:white; }
    .btn-refresh { background:#ca8a04; color:white; }
    .btn-export { background:#3b82f6; color:white; }
    .btn-print { background:#6b7280; color:white; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 0.8rem;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: 700;
    }

    tr:hover { background:#f8fafc; }

    .rent { color: var(--success); font-weight: bold; }
    .arrears { color: var(--danger); font-weight: bold; }

    /* Mobile */
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #ccc; margin-bottom: 1rem; border-radius: 10px; padding: 1rem; }
      td { border: none; position: relative; padding-left: 50%; text-align: right; }
      td:before { content: attr(data-label); position: absolute; left: 1rem; width: 45%; font-weight: bold; text-align: right; }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 1.2rem;
      border-radius: 12px;
      width: 95%;
      max-width: 720px;
    }
    .close { float: left; font-size: 2rem; cursor: pointer; }

    #loading {
      position: fixed;
      inset: 0;
      background: rgba(30,58,138,0.95);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 9999;
    }

    .coin { font-size: 4rem; animation: spin 2s linear infinite; }
    @keyframes spin { from {transform:rotate(0deg);} to {transform:rotate(360deg);} }

    .actions button { margin: 0 .15rem; padding: .4rem .6rem; border-radius:6px }

  </style>
</head>
<body>

<div id="loading">
  <i class="fas fa-coins coin"></i>
  <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ‚Ù...</div>
</div>

<header>
  <h1>ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©</h1>
  <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©</p>
</header>

<div class="container">

  <div class="stats" id="totalRent">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>

  <!-- ğŸ” ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØµÙÙŠØ§Øª -->
  <div class="filters-box" style="
    background:white;padding:1rem;border-radius:12px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);margin-bottom:1rem;
  ">
    <h3 style="margin-bottom:1rem;text-align:center;font-weight:900;color:#1e40af;">ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶</h3>

    <div style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;">

      <select id="filterNahya" style="padding:.6rem;border-radius:8px;border:2px solid #ddd;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ø­ÙŠØ©</option>
      </select>

      <select id="filterType" style="padding:.6rem;border-radius:8px;border:2px solid #ddd;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
      </select>

      <select id="filterWaqf" style="padding:.6rem;border-radius:8px;border:2px solid #ddd;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Ù</option>
      </select>

      <select id="filterHod" style="padding:.6rem;border-radius:8px;border:2px solid #ddd;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙˆØ¶</option>
      </select>
    </div>

    <div style="text-align:center;margin-top:1rem;">
      <button onclick="applyFilters()" style="background:#1e40af;color:white;padding:.6rem 1.2rem;border-radius:8px;">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
    </div>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="controls">
    <input type="text" id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„..." />
    <button class="btn-add" onclick="openModal()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
    <button class="btn-refresh" onclick="loadFromGitHub(true)"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
    <button class="btn-export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ±</button>
    <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Ù…</th><th>Ø§Ù„Ù†Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆÙ‚Ù</th><th>Ø§Ù„ØµÙØ­Ø©</th>
        <th>Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©</th><th>Ø§Ù„Ø­ÙˆØ¶</th><th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th><th>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</th>
        <th class="rent">Ø£Ø¬Ø±Ø© Ø´Ù‡Ø±ÙŠØ©</th><th class="arrears">Ù…ØªØ£Ø®Ø±Ø§Øª</th>
        <th class="rent">Ø£Ø¬Ø±Ø© Ø³Ù†ÙˆÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</h2>

    <form id="dataForm">
      <input type="hidden" id="editId" />

      <div class="form-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
        <input id="col1" placeholder="Ù…" required>
        <input id="col2" placeholder="Ø§Ù„Ù†Ø§Ø­ÙŠØ©" required>
        <input id="col3" placeholder="Ø§Ù„Ù†ÙˆØ¹" required>
        <input id="col4" placeholder="Ø§Ù„ÙˆÙ‚Ù" required>
        <input id="col5" placeholder="Ø§Ù„ØµÙØ­Ø©">
        <input id="col6" placeholder="Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©">
        <input id="col7" placeholder="Ø§Ù„Ø­ÙˆØ¶">
        <input id="col8" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required>
        <input id="col9" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©">
        <input type="number" id="col10" placeholder="Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©" step="0.01" required>
        <input type="number" id="col11" placeholder="Ù…ØªØ£Ø®Ø±Ø§Øª" step="0.01" value="0">
      </div>

      <div style="text-align:center;margin-top:1rem;">
        <button style="background:#16a34a;color:white;padding:0.8rem 1.6rem;" type="submit"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
      </div>

    </form>
  </div>
</div>

<script>
/* =============================== */
/*   Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù†Ø³Ø®Ø© ÙƒØ§Ø¦Ù†Ø§Øª) */
/* =============================== */

// Ø±Ø§Ø¨Ø· CSV (Ù†ÙØ³Ù‡ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ)
const CSV_URL = "https://raw.githubusercontent.com/abukora/waqf-eskan/main/eskan.csv";
let data = []; // Ø³Ù†Ø®Ø²Ù† Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª: {id, col1, col2, ...}
let fuse;

const COLUMNS = [
  "Ù…","Ø§Ù„Ù†Ø§Ø­ÙŠØ©","Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„ÙˆÙ‚Ù","Ø§Ù„ØµÙØ­Ø©","Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©","Ø§Ù„Ø­ÙˆØ¶",
  "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±","Ø§Ù„Ù…Ø³Ø§Ø­Ø©","Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©","Ù…ØªØ£Ø®Ø±Ø§Øª","Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©"
];

/* =============================== */
/*   Ù…Ø³Ø§Ø¹Ø¯: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯      */
/* =============================== */
function makeId() {
  return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
}

/* =============================== */
/*   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª                */
/* =============================== */
async function loadFromGitHub(force = false) {
  const saved = localStorage.getItem("waqfData");
  const savedTime = localStorage.getItem("waqfTime");

  if (!force && saved && savedTime && Date.now() - savedTime < 86400000) {
    try {
      data = JSON.parse(saved);
      initApp();
      document.getElementById("loading").style.display = "none";
      return;
    } catch(e){
      console.warn('Ø®Ø·Ø£ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŒ Ø³Ù†Ø¬Ø±Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.');
    }
  }

  try {
    const res = await fetch(CSV_URL + "?t=" + Date.now());
    const text = await res.text();

    Papa.parse(text, {
      complete: ({ data: rows }) => {
        // rows[0] header
        const remote = rows.slice(1).filter(r => r && r[0]);
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†Ø§Øª Ù…Ø¹ id
        const remoteObjs = remote.map(r => {
          return {
            id: r[12] || makeId(), // Ø¥Ø°Ø§ CSV ÙŠØ­ØªÙˆÙŠ id ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 12 Ø§Ø³ØªØ®Ø¯Ù…Ù‡
            col1: r[0] || "",
            col2: r[1] || "",
            col3: r[2] || "",
            col4: r[3] || "",
            col5: r[4] || "",
            col6: r[5] || "",
            col7: r[6] || "",
            col8: r[7] || "",
            col9: r[8] || "",
            col10: r[9] || "0",
            col11: r[10] || "0",
          };
        });

        if (saved) {
          const localObjs = JSON.parse(saved);
          data = mergeData(localObjs, remoteObjs);
        } else {
          data = remoteObjs;
        }

        saveData();
        initApp();
      }
    });

  } catch (err) {
    console.warn('ÙØ´Ù„ Ø¬Ù„Ø¨ CSV:', err);
    if (saved) {
      data = JSON.parse(saved);
      initApp();
    }
  }

  document.getElementById("loading").style.display = "none";
}

/* Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†Ø³ØªØ®Ø¯Ù… id Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø·Ø§Ø¨Ù‚ Ø¹Ù„Ù‰ (col1 + col8) ÙƒØ®Ø·Ø© Ø§Ø­ØªÙŠØ§Ø· */
function mergeData(local, remote) {
  const map = new Map();
  // Ø£Ø¶Ù Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
  local.forEach(r => map.set(r.id || (r.col1 + '|' + r.col8), r));
  remote.forEach(r => {
    const key = r.id || (r.col1 + '|' + r.col8);
    if (!map.has(key)) map.set(key, r);
  });
  return Array.from(map.values());
}

function saveData() {
  localStorage.setItem("waqfData", JSON.stringify(data));
  localStorage.setItem("waqfTime", Date.now());
}

/* =============================== */
/*   Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ               */
/* =============================== */
function initApp() {
  // ØªÙ‡ÙŠØ¦Ø© Fuse Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­Ù‚ÙˆÙ„ (Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙØ§ØªÙŠØ­ Ù†ØµÙŠØ©)
  const fuseList = data.map(d => ({
    id: d.id,
    text: [d.col1,d.col2,d.col3,d.col4,d.col5,d.col6,d.col7,d.col8,d.col9,d.col10,d.col11].join(' | ')
  }));

  fuse = new Fuse(fuseList, { keys: ['text'], threshold: 0.3 });

  fillFilters();
  renderTable(data);
  calcTotal(data);
}

/* =============================== */
/*   Ù…Ù„Ø¡ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ            */
/* =============================== */
function fillFilters() {
  const nahya = new Set();
  const type = new Set();
  const waqf = new Set();
  const hod = new Set();

  data.forEach(r => {
    if (r.col2) nahya.add(r.col2);
    if (r.col3) type.add(r.col3);
    if (r.col4) waqf.add(r.col4);
    if (r.col7) hod.add(r.col7);
  });

  fillSelect("filterNahya", nahya);
  fillSelect("filterType", type);
  fillSelect("filterWaqf", waqf);
  fillSelect("filterHod", hod);
}

function fillSelect(id, setValues) {
  const select = document.getElementById(id);
  select.innerHTML = '<option value="">Ø§Ø®ØªÙŠØ§Ø±</option>';
  Array.from(setValues).sort().forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    select.appendChild(op);
  });
}

/* =============================== */
/*   ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©                 */
/* =============================== */
function applyFilters() {
  const f1 = document.getElementById('filterNahya').value;
  const f2 = document.getElementById('filterType').value;
  const f3 = document.getElementById('filterWaqf').value;
  const f4 = document.getElementById('filterHod').value;

  let filtered = data.slice();

  if (f1) filtered = filtered.filter(r => r.col2 === f1);
  if (f2) filtered = filtered.filter(r => r.col3 === f2);
  if (f3) filtered = filtered.filter(r => r.col4 === f3);
  if (f4) filtered = filtered.filter(r => r.col7 === f4);

  renderTable(filtered);
  calcTotal(filtered);
  document.getElementById("dataTable").style.display = filtered.length ? 'table' : 'none';
}

/* =============================== */
/*   Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… id Ø«Ø§Ø¨Øª)*/
/* =============================== */
function renderTable(records) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  records.forEach((row, idx) => {
    const tr = document.createElement("tr");

    const cells = [row.col1,row.col2,row.col3,row.col4,row.col5,row.col6,row.col7,row.col8,row.col9,row.col10,row.col11];

    for (let i = 0; i < cells.length; i++) {
      const td = document.createElement("td");
      td.textContent = cells[i] || "";
      td.dataset.label = COLUMNS[i];
      if (i === 9) td.className = "rent";
      if (i === 10) td.className = "arrears";
      tr.appendChild(td);
    }

    // Ø­Ø³Ø§Ø¨ Ø³Ù†ÙˆÙŠ Ù…Ø¹ Ø¹Ø±Ø¶ Ø¯Ù‚ÙŠÙ‚
    const annual = ((parseFloat(row.col10) || 0) * 12).toFixed(2);
    const tdAnnual = document.createElement("td");
    tdAnnual.textContent = annual;
    tdAnnual.className = "rent";
    tr.appendChild(tdAnnual);

    const tdAct = document.createElement("td");
    tdAct.className = 'actions';
    tdAct.innerHTML = `
      <button onclick="editRowById('${row.id}')" style="background:#3b82f6;color:white;"><i class="fas fa-edit"></i></button>
      <button onclick="deleteRowById('${row.id}')" style="background:#dc2626;color:white;"><i class="fas fa-trash"></i></button>
    `;
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  });
}

/* =============================== */
/*   Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª                      */
/* =============================== */
function calcTotal(records) {
  const total = records.reduce((s, r) => s + (parseFloat(r.col10) || 0) * 12, 0);
  document.getElementById('totalRent').textContent = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©: " + total.toLocaleString('ar-EG') + " Ø¬Ù†ÙŠÙ‡";
}

/* =============================== */
/*   Ø§Ù„Ø¨Ø­Ø«                         */
/* =============================== */
const searchInput = document.getElementById('search');
searchInput.oninput = () => {
  const t = searchInput.value.trim();
  if (!t) {
    renderTable(data);
    calcTotal(data);
    document.getElementById("dataTable").style.display = data.length ? 'table' : 'none';
    return;
  }

  const results = fuse.search(t).map(r => data.find(d => d.id === r.item.id));
  const found = results.filter(Boolean);
  renderTable(found);
  calcTotal(found);
  document.getElementById("dataTable").style.display = found.length ? 'table' : 'none';
};

/* =============================== */
/*   Ø§Ù„Ù…ÙˆØ¯Ø§Ù„                       */
/* =============================== */
function openModal() {
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±';
  document.getElementById('dataForm').reset();
  document.getElementById('editId').value = '';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

/* =============================== */
/*   Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„)   */
/* =============================== */
const dataForm = document.getElementById('dataForm');
dataForm.onsubmit = e => {
  e.preventDefault();

  const row = {
    id: document.getElementById('editId').value || makeId(),
    col1: document.getElementById('col1').value || '',
    col2: document.getElementById('col2').value || '',
    col3: document.getElementById('col3').value || '',
    col4: document.getElementById('col4').value || '',
    col5: document.getElementById('col5').value || '',
    col6: document.getElementById('col6').value || '',
    col7: document.getElementById('col7').value || '',
    col8: document.getElementById('col8').value || '',
    col9: document.getElementById('col9').value || '',
    col10: document.getElementById('col10').value || '0',
    col11: document.getElementById('col11').value || '0',
  };

  const editId = document.getElementById('editId').value;
  if (editId) {
    // ØªØ¹Ø¯ÙŠÙ„: Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙÙ‡Ø±Ø³ Ø¹Ù† Ø·Ø±ÙŠÙ‚ id
    const idx = data.findIndex(d => d.id === editId);
    if (idx > -1) data[idx] = row;
  } else {
    data.push(row);
  }

  saveData();
  initApp();
  closeModal();
};

/* =============================== */
/*   ØªØ­Ø±ÙŠØ±/Ø­Ø°Ù Ø­Ø³Ø¨ id            */
/* =============================== */
function editRowById(id) {
  const r = data.find(d => d.id === id);
  if (!r) return alert('Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

  document.getElementById('col1').value = r.col1 || '';
  document.getElementById('col2').value = r.col2 || '';
  document.getElementById('col3').value = r.col3 || '';
  document.getElementById('col4').value = r.col4 || '';
  document.getElementById('col5').value = r.col5 || '';
  document.getElementById('col6').value = r.col6 || '';
  document.getElementById('col7').value = r.col7 || '';
  document.getElementById('col8').value = r.col8 || '';
  document.getElementById('col9').value = r.col9 || '';
  document.getElementById('col10').value = r.col10 || '0';
  document.getElementById('col11').value = r.col11 || '0';
  document.getElementById('editId').value = r.id;

  document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ£Ø¬Ø±';
  openModal();
}

function deleteRowById(id) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
  const idx = data.findIndex(d => d.id === id);
  if (idx > -1) {
    data.splice(idx,1);
    saveData();
    initApp();
  }
}

/* =============================== */
/*   ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„                    */
/* =============================== */
function exportToExcel() {
  const exportData = data.map(r => {
    const obj = {};
    COLUMNS.forEach((c, i) => obj[c] = r['col'+(i+1)] || '');
    obj['Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©'] = ((parseFloat(r.col10) || 0) * 12).toFixed(2);
    return obj;
  });

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª");
  XLSX.writeFile(wb, "Ø¥ÙŠØ¬Ø§Ø±Ø§Øª_Ø§Ù„ÙˆÙ‚Ù_Ù…Ø¹Ø¯Ù„Ø©.xlsx");
}

/* =============================== */
/*   Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­         */
/* =============================== */
loadFromGitHub();
window.onclick = e => { if (e.target === document.getElementById('modal')) closeModal(); };
</script>

</body>
</html>
