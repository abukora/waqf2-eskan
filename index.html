<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --success: #16a34a;
      --warning: #ca8a04;
      --danger: #dc2626;
      --gold: #fbbf24;
      --bg-gradient: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      --header-gradient: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: #1f2937;
    }
    header {
      background: var(--header-gradient);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    h1 { font-size: 2rem; font-weight: 900; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
    .controls {
      display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; justify-content: center;
      background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    input, button, select {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
    }
    #search { flex: 1; min-width: 250px; border: 2px solid #ddd; }
    button {
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-add { background: var(--success); color: white; }
    .btn-update { background: var(--primary-light); color: white; }
    .btn-export { background: var(--gold); color: #000; }
    .btn-print { background: #6b7280; color: white; }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    .total-box {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--success);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: var(--primary);
      color: white;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr:hover { background: #f8fafc; }
    .encroachment { color: var(--danger); font-weight: bold; }
    .rent { color: var(--success); font-weight: bold; }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .card h3 { color: var(--primary); margin-bottom: 0.5rem; }

    .loading {
      position: fixed;
      inset: 0;
      background: rgba(30,58,138,0.95);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 1.5rem;
    }
    .coin {
      font-size: 4rem;
      animation: spin 2s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { from {transform:rotate(0deg);} to {transform:rotate(360deg);} }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #ccc; border-radius: 10px; margin-bottom: 1rem; padding: 1rem; }
      td { border: none; position: relative; padding-left: 50%; text-align: right; }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        width: 45%;
        font-weight: bold;
        color: var(--primary);
      }
      .desktop-only { display: none !important; }
      .controls { flex-direction: column; }
      #search { min-width: auto; }
    }

    @media print {
      body * { visibility: hidden; }
      .container, .container * { visibility: visible; }
      .container { position: absolute; left: 0; top: 0; }
      .controls, .btn-print { display: none; }
    }
  </style>
</head>
<body>

<div class="loading" id="loading">
  <i class="fas fa-coins coin"></i>
  <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©...</div>
</div>

<header>
  <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©</h1>
  <p class="subtitle">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ 2025</p>
</header>

<div class="container">
  <div class="total-box" id="totalRent">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª: 0 Ø¬Ù†ÙŠÙ‡</div>

  <div class="controls">
    <input type="text" id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„..."/>
    <button class="btn-add" onclick="openForm('add')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
    <button class="btn-update" onclick="updateFromSource()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±</button>
    <button class="btn-export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
    <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>

  <div id="desktopView">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
          <th>Ø§Ù„Ù†Ø§Ø­ÙŠØ©</th>
          <th>Ø³</th>
          <th>Ø·</th>
          <th>Ù</th>
          <th>Ø§Ù„ØªØ¹Ø¯ÙŠØ§Øª</th>
          <th>Ø§Ù„Ø§ÙŠØ¬Ø§Ø±</th>
          <th>Ø§Ù„Ø®ÙØ±</th>
          <th>Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</th>
          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
          <th>3%</th>
          <th>Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
          <th class="desktop-only">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="mobileView"></div>
</div>

<!-- Modal -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; display:flex; align-items:center; justify-content:center;">
  <div style="background:white; padding:2rem; border-radius:15px; width:90%; max-width:500px;">
    <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯</h2>
    <form id="tenantForm">
      <input type="hidden" id="editIndex"/>
      <div style="margin:1rem 0;">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
        <input type="text" id="name" required style="width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:8px;"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø³</label>
        <input type="number" id="s" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø·</label>
        <input type="number" id="t" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ù</label>
        <input type="number" id="f" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø§Ù„ØªØ¹Ø¯ÙŠØ§Øª</label>
        <input type="text" id="encroachment"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø§Ù„Ø§ÙŠØ¬Ø§Ø±</label>
        <input type="number" id="rent" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø§Ù„Ø®ÙØ±</label>
        <input type="number" id="guard" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</label>
        <input type="number" id="insurance" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
        <input type="number" id="mail" value="0" step="0.01"/>
      </div>
      <div style="margin:1rem 0;">
        <label>3%</label>
        <input type="number" id="threePercent" value="0" step="0.01"/>
      </div>
      <div style="margin:2rem 0; text-align:center;">
        <button type="button" onclick="saveTenant()" style="background:var(--success); color:white; padding:0.75rem 2rem; margin:0 0.5rem;">Ø­ÙØ¸</button>
        <button type="button" onclick="closeModal()" style="background:#999; color:white; padding:0.75rem 2rem; margin:0 0.5rem;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>

<script>
const SHEET_ID = "1bX-Tx2K_4iAUqkkZbKwL_TZ0RFSIo2PLAMxpcZK-cOE";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

let tenants = [];
let fuse;

async function loadData() {
  try {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = text.split('\n').map(r => r.trim()).filter(r => r);
    const data = rows.slice(1).map(row => {
      const cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
      return {
        id: cols[0] || Date.now(),
        name: cols[1] || '',
        area: 'Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©',
        s: parseFloat(cols[3]) || 0,
        t: parseFloat(cols[4]) || 0,
        f: parseFloat(cols[5]) || 0,
        encroachment: cols[6] || '',
        rent: parseFloat(cols[7]) || 0,
        guard: parseFloat(cols[8]) || 0,
        insurance: parseFloat(cols[9]) || 0,
        mail: parseFloat(cols[10]) || 0,
        threePercent: parseFloat(cols[11]) || 0,
      };
    });

    const saved = localStorage.getItem('waqf-fatima-2025');
    if (saved) {
      const localData = JSON.parse(saved);
      tenants = mergeData(data, localData); // Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    } else {
      tenants = data;
    }

    fuse = new Fuse(tenants, {
      keys: Object.keys(tenants[0] || {}),
      threshold: 0.4,
      includeScore: true
    });

    render();
    document.getElementById('loading').style.display = 'none';
  } catch (e) {
    alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª');
    loadFromLocal();
  }
}

function mergeData(source, local) {
  const map = new Map();
  local.forEach(t => map.set(t.id, t));
  source.forEach(t => {
    if (!map.has(t.id)) map.set(t.id, t);
  });
  return Array.from(map.values());
}

function loadFromLocal() {
  const saved = localStorage.getItem('waqf-fatima-2025');
  if (saved) {
    tenants = JSON.parse(saved);
    render();
  }
  document.getElementById('loading').style.display = 'none';
}

function saveToLocal() {
  localStorage.setItem('waqf-fatima-2025', JSON.stringify(tenants));
}

function calculateTotal(row) {
  return row.rent + row.guard + row.insurance + row.mail + row.threePercent;
}

function render() {
  const tbody = document.getElementById('tableBody');
  const mobile = document.getElementById('mobileView');
  tbody.innerHTML = '';
  mobile.innerHTML = '';

  let total = 0;
  tenants.forEach((t, i) => {
    t.total = calculateTotal(t);
    total += t.total;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${t.name}</td>
      <td>${t.area}</td>
      <td>${t.s}</td>
      <td>${t.t}</td>
      <td>${t.f}</td>
      <td class="encroachment">${t.encroachment}</td>
      <td class="rent">${t.rent.toFixed(2)}</td>
      <td>${t.guard.toFixed(2)}</td>
      <td>${t.insurance.toFixed(2)}</td>
      <td>${t.mail.toFixed(2)}</td>
      <td>${t.threePercent.toFixed(2)}</td>
      <td class="rent">${t.total.toFixed(2)}</td>
      <td class="desktop-only">
        <button onclick="editTenant(${i})" style="background:#3b82f6; color:white; padding:0.5rem; margin:0 0.25rem;"><i class="fas fa-edit"></i></button>
        <button onclick="deleteTenant(${i})" style="background:var(--danger); color:white; padding:0.5rem; margin:0 0.25rem;"><i class="fas fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(tr);

    // Mobile Card
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${t.name}</h3>
      <p><strong>Ø§Ù„ØªØ¹Ø¯ÙŠØ§Øª:</strong> <span class="encroachment">${t.encroachment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
      <p><strong>Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</strong> <span class="rent">${t.total.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></p>
      <div style="margin-top:1rem;">
        <button onclick="editTenant(${i})" style="background:#3b82f6; color:white; padding:0.5rem 1rem; margin:0 0.25rem;">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteTenant(${i})" style="background:var(--danger); color:white; padding:0.5rem 1rem; margin:0 0.25rem;">Ø­Ø°Ù</button>
      </div>
    `;
    mobile.appendChild(card);
  });

  document.getElementById('totalRent').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª: ${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
  saveToLocal();
}

document.getElementById('search').addEventListener('input', (e) => {
  const term = e.target.value;
  if (!term) {
    render();
    return;
  }
  const results = fuse.search(term);
  tenants = results.map(r => r.item);
  render();
});

function openForm(mode = 'add', index = null) {
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').textContent = mode === 'add' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯' : 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±';
  if (mode === 'add') {
    document.getElementById('tenantForm').reset();
    document.getElementById('editIndex').value = '';
  } else {
    const t = tenants[index];
    document.getElementById('editIndex').value = index;
    document.getElementById('name').value = t.name;
    document.getElementById('s').value = t.s;
    document.getElementById('t').value = t.t;
    document.getElementById('f').value = t.f;
    document.getElementById('encroachment').value = t.encroachment;
    document.getElementById('rent').value = t.rent;
    document.getElementById('guard').value = t.guard;
    document.getElementById('insurance').value = t.insurance;
    document.getElementById('mail').value = t.mail;
    document.getElementById('threePercent').value = t.threePercent;
  }
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function saveTenant() {
  const index = document.getElementById('editIndex').value;
  const tenant = {
    id: tenants[index]?.id || Date.now(),
    name: document.getElementById('name').value.trim(),
    area: 'Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©',
    s: parseFloat(document.getElementById('s').value) || 0,
    t: parseFloat(document.getElementById('t').value) || 0,
    f: parseFloat(document.getElementById('f').value) || 0,
    encroachment: document.getElementById('encroachment').value,
    rent: parseFloat(document.getElementById('rent').value) || 0,
    guard: parseFloat(document.getElementById('guard').value) || 0,
    insurance: parseFloat(document.getElementById('insurance').value) || 0,
    mail: parseFloat(document.getElementById('mail').value) || 0,
    threePercent: parseFloat(document.getElementById('threePercent').value) || 0,
  };

  if (index === '') {
    tenants.push(tenant);
  } else {
    tenants[index] = tenant;
  }

  closeModal();
  render();
}

function editTenant(i) { openForm('edit', i); }
function deleteTenant(i) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŸ')) {
    tenants.splice(i, 1);
    render();
  }
}

async function updateFromSource() {
  document.getElementById('loading').style.display = 'flex';
  await loadData();
}

async function exportToExcel() {
  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù…');

  ws.columns = [
    { header: 'Ù…', key: 'index' },
    { header: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±', key: 'name' },
    { header: 'Ø§Ù„Ù†Ø§Ø­ÙŠØ©', key: 'area' },
    { header: 'Ø³', key: 's' },
    { header: 'Ø·', key: 't' },
    { header: 'Ù', key: 'f' },
    { header: 'Ø§Ù„ØªØ¹Ø¯ÙŠØ§Øª', key: 'encroachment' },
    { header: 'Ø§Ù„Ø§ÙŠØ¬Ø§Ø±', key: 'rent' },
    { header: 'Ø§Ù„Ø®ÙØ±', key: 'guard' },
    { header: 'Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª', key: 'insurance' },
    { header: 'Ø§Ù„Ø¨Ø±ÙŠØ¯', key: 'mail' },
    { header: '3%', key: 'threePercent' },
    { header: 'Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±', key: 'total' },
  ];

  tenants.forEach((t, i) => {
    t.total = calculateTotal(t);
    ws.addRow({ ...t, index: i+1 });
  });

  ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
  ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1e40af' } };

  const buf = await wb.xlsx.writeBuffer();
  saveAs(new Blob([buf]), 'Ø¥ÙŠØ¬Ø§Ø±Ø§Øª_ÙˆÙ‚Ù_ÙØ§Ø·Ù…Ø©_Ù‡Ø§Ù†Ù…_Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©_2025.xlsx');
}

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
window.onload = loadData;
</script>
</body>
</html>
